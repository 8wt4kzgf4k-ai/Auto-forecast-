<!DOCTYPE html>
<html>
<head>
    <title>EUR/USD Forecast Dashboard</title>
    <style>
        body { 
            font-family: Arial; 
            background: #111; 
            color: white; 
            text-align: center; 
            transition: background 0.5s, color 0.5s;
        }
        .card { 
            border: 1px solid #444; 
            margin: 10px; 
            padding: 10px; 
            display: inline-block; 
            width: 220px; 
            border-radius: 5px;
            transition: background 0.5s, color 0.5s;
        }
        .error { color: red; margin-top: 20px; }
        .warning { color: yellow; margin-top: 10px; }
        .trend { font-size: 1.5em; }
        .timer { font-size: 0.9em; margin-top: 5px; color: #ccc; }
    </style>
</head>
<body>
    <h1>EUR/USD Forecast Dashboard</h1>
    <div id="data">Loading forecast...</div>
    <div id="error" class="error"></div>

    <script>
        function adjustTextColor(el, bgColor) {
            const r = parseInt(bgColor.substr(1,2),16);
            const g = parseInt(bgColor.substr(3,2),16);
            const b = parseInt(bgColor.substr(5,2),16);
            const brightness = (r*299 + g*587 + b*114)/1000;
            el.style.color = (brightness < 128) ? 'white' : 'black';
        }

        function timeAgo(datetime) {
            const now = new Date();
            const past = new Date(datetime);
            const diffMs = now - past;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffH = Math.floor(diffMin / 60);

            if (diffH > 0) return `${diffH}h ${diffMin % 60}m ago`;
            if (diffMin > 0) return `${diffMin}m ${diffSec % 60}s ago`;
            return `${diffSec}s ago`;
        }

        async function loadForecast() {
            const dataDiv = document.getElementById("data");
            const errorDiv = document.getElementById("error");
            errorDiv.innerText = "";
            dataDiv.innerHTML = "Loading forecast...";
            try {
                const res = await fetch("/forecast.json?t=" + new Date().getTime());
                if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
                const data = await res.json();

                const TIMEFRAMES = ["1min","3min","5min","15min","30min","1h"];
                let html = "";
                let missingFrames = [];

                for (const tf of TIMEFRAMES) {
                    const tfData = data[tf];
                    if (!tfData || tfData.length === 0) {
                        missingFrames.push(tf);
                        html += `<div class="card" style="background:#ffb200">
                                    <h2>${tf}</h2>
                                    <p>Data missing</p>
                                 </div>`;
                        continue;
                    }

                    const last = tfData[tfData.length - 1];
                    const trendArrow = last.signal === "Buy" ? "ðŸ“ˆ" : "ðŸ“‰";
                    const cardColor = last.confidence === 3 ? "#2a8f2a" :
                                      last.confidence === 2 ? "#f0a500" :
                                      "#d42a2a";

                    html += `<div class="card" style="background:${cardColor}">
                                <h2>${tf}</h2>
                                <p>Price: ${last.price}</p>
                                <p>Signal: <span class="trend">${trendArrow} ${last.signal}</span></p>
                                <p>Confidence: ${last.meter}</p>
                                <p class="timer">Updated: ${timeAgo(last.time)}</p>
                             </div>`;
                }

                dataDiv.innerHTML = html;

                // Adjust text color for readability
                document.querySelectorAll('.card').forEach(card => {
                    adjustTextColor(card, card.style.background);
                });

                if (missingFrames.length > 0) {
                    errorDiv.innerHTML = `<p class="warning">Missing forecast data for: ${missingFrames.join(", ")}</p>`;
                }

            } catch (err) {
                dataDiv.innerHTML = "<p>Unable to load forecast data.</p>";
                errorDiv.innerText = "Fetch Error: " + err.message;
                console.error(err);
            }
        }

        // Refresh dashboard and update timers every second
        setInterval(loadForecast, 1000); // updates timers live
        loadForecast();
    </script>
</body>
</html>
