<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>EUR/USD Forecast</title>
<style>
body { font-family: Arial; background:#111; color:white; }
.box { border:1px solid #444; padding:10px; margin:10px; border-radius:8px; }
.buy { color:lime; }
.sell { color:red; }
.closed { color:orange; }

@keyframes flash {
  0% { background-color: yellow; color: black; }
  50% { background-color: orange; color: white; }
  100% { background-color: yellow; color: black; }
}
.flash { animation: flash 1s ease-in-out infinite; }
</style>
</head>
<body>

<h2>EUR/USD Forecast Dashboard (UTC)</h2>
<div id="dashboard"></div>

<script>
const timeframes = ["1min","3min","5min","15min","30min","1h"];
const lastSignals = {};
const countdowns = {};

// Contrast function for dynamic text
function getContrastYIQ(rgb){
    const rgbVals = rgb.match(/\d+/g);
    if(!rgbVals) return "white";
    let r = parseInt(rgbVals[0]), g = parseInt(rgbVals[1]), b = parseInt(rgbVals[2]);
    let yiq = ((r*299)+(g*587)+(b*114))/1000;
    return (yiq >= 128) ? 'black' : 'white';
}

// Fetch forecast JSON and render dashboard
async function fetchForecast(){
  const res = await fetch("/forecast.json");
  const data = await res.json();
  const dash = document.getElementById("dashboard");
  dash.innerHTML = "";

  const now = new Date();

  timeframes.forEach(tf=>{
    const entries = data[tf];
    if(!entries || entries.length===0) return;
    const last = entries[entries.length-1];
    let cls = last.signal==="Buy"?"buy": last.signal==="Sell"?"sell":"closed";

    // Detect new signal
    let isNew = false;
    if(lastSignals[tf] !== last.signal + last.predicted_price){
      isNew = true;
      lastSignals[tf] = last.signal + last.predicted_price;
    }

    // Calculate countdown
    let lastForecastTime = new Date(last.forecast_time);
    let nextUpdateInSec = Math.max(0, 60 - Math.floor((now - lastForecastTime)/1000));
    countdowns[tf] = nextUpdateInSec;

    dash.innerHTML += `
      <div class="box" id="box-${tf}">
        <b>${tf}</b><br>
        Signal: <span class="${cls}" id="signal-${tf}">${last.signal}</span><br>
        Reversal: ${last.reversal ? "⚠️ YES" : "No"}<br>
        Acceleration: ${last.acceleration}<br>
        Price: ${last.price ?? "N/A"}<br>
        Forecast time (UTC): ${last.forecast_time}<br>
        Candle time (UTC): ${last.candle_time ?? "N/A"}<br>
        Next update in: <span id="count-${tf}">${nextUpdateInSec}</span> sec
      </div>
    `;

    // Flash new signal
    if(isNew){
      const box = document.getElementById(`box-${tf}`);
      box.classList.add("flash");
      setTimeout(()=>{ box.classList.remove("flash"); }, 15000);
    }

    // Adjust text color based on background
    const box = document.getElementById(`box-${tf}`);
    const bg = window.getComputedStyle(box).backgroundColor;
    box.style.color = getContrastYIQ(bg);
  });
}

// Update countdown timers every second
function updateCountdowns(){
  timeframes.forEach(tf=>{
    if(countdowns[tf] !== undefined){
      if(countdowns[tf] > 0){
        countdowns[tf]--;
        const span = document.getElementById(`count-${tf}`);
        if(span) span.textContent = countdowns[tf];
      }
    }
  });
}

// Initial fetch
fetchForecast();

// Refresh forecast every 5 seconds
setInterval(fetchForecast, 5000);

// Update countdown timers every 1 second
setInterval(updateCountdowns, 1000);
</script>

</body>
</html>
